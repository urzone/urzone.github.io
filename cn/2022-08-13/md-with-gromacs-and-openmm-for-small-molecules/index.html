<!DOCTYPE html>
<html lang="cmn-Hans-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>基于 Gromacs 和 OpenMM 的小分子分子动力学模拟 - XiaO | 缄默之语</title>
    <meta property="og:title" content="基于 Gromacs 和 OpenMM 的小分子分子动力学模拟 - XiaO | 缄默之语">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="Gromacs 分子动力学模拟的输入文件：
[&amp;hellip;] OpenMM 分子动力学模拟的输出文件：
[&amp;hellip;] 此处，我们将模拟 pyrene 在水中的聚集行为，故在根目录下新建文件夹 pyrene，并将终端的工作目录改变到此文件夹。
在终端中安装 open-babel：
[&amp;hellip;] brew install open-babel 在终端中将分子的 SMILES 格式  &amp;hellip;">
      <meta property="og:description" content="Gromacs 分子动力学模拟的输入文件：
[&amp;hellip;] OpenMM 分子动力学模拟的输出文件：
[&amp;hellip;] 此处，我们将模拟 pyrene 在水中的聚集行为，故在根目录下新建文件夹 pyrene，并将终端的工作目录改变到此文件夹。
在终端中安装 open-babel：
[&amp;hellip;] brew install open-babel 在终端中将分子的 SMILES 格式  &amp;hellip;">
      
    

    
    
    
    <meta name="twitter:image" content="https://urz.one/images/logo.png">
    
    

    

    
    
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    



<link rel="stylesheet" href="/css/custom.css" />


<link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png">
<link rel="manifest" href="/images/icons/manifest.json">
<link rel="mask-icon" href="/images/icons/safari-pinned-tab.svg" color="#cc342c">
<link rel="shortcut icon" href="/images/icons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="XiaO">
<meta name="application-name" content="XiaO">
<meta name="msapplication-TileColor" content="#603cba">
<meta name="msapplication-TileImage" content="/images/icons/mstile-144x144.png">
<meta name="msapplication-config" content="/images/icons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<meta name="google-site-verification" content="3C4lz-WqreDsFFohPRed1rO14aKeEDmTbw2lfIHN6og" />
  </head>

  
  <body class="cn">
    <header class="masthead">
      

<h1><a href="/"><img src="/images/logo.svg" alt="XiaO" /></a></h1>



      <nav class="menu">
  <ul>
  
  
  <li><a href="/">首页</a></li>
  
  <li><a href="/cn/">日志</a></li>
  
  <li><a href="/cn/note/">缄语</a></li>
  
  <li><a href="/en/">En</a></li>
  
  

<li class="menu-extra"></li>


<li><a href="/cn/index.xml" type="application/rss+xml" title="RSS feed">订阅</a></li>

<li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="Attribution-NonCommercial-ShareAlike 4.0 International">版权</a></li>


  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>基于 Gromacs 和 OpenMM 的小分子分子动力学模拟</h1>


<h3>XiaO / 
2022-08-13</h3>

<hr>


      </header>



<p>Gromacs 分子动力学模拟的输入文件：</p>
<ul>
<li>描述分子结构的文件，mol2、pdb、<strong>gro</strong>。</li>
<li>描述分子力场的文件：<strong>*.top</strong> 文件，其包含了模拟所需的所有力场信息，还可包含对 <strong>*.itp</strong> 文件的引用，<strong>*.itp</strong> 文件描述了某种特定分子所使用的力场。</li>
</ul>
<p>OpenMM 分子动力学模拟的输出文件：</p>
<ul>
<li><strong>checkpoint.chk</strong>: 记录当前模拟的所有信息，如系统状态参数（温度、压力），粒子位置和速度，精度等。</li>
<li><strong>trajectory.dcd</strong>: 二进制的轨迹文件，它存储了所有原子的座标随时间变化的信息。</li>
<li>log.txt: 记录模拟过程中的变化信息</li>
</ul>
<h2 id="准备输入文件">准备输入文件</h2>
<h3 id="分子结构文件">分子结构文件</h3>
<p>此处，我们将模拟 pyrene 在水中的聚集行为，故在根目录下新建文件夹 <code>pyrene</code>，并将终端的工作目录改变到此文件夹。</p>
<p>在终端中安装 <a href="https://buildmedia.readthedocs.org/media/pdf/open-babel/latest/open-babel.pdf">open-babel</a>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>brew install open-babel
</span></span></code></pre></div><p>在终端中将分子的 <a href="https://openbabel.org/docs/dev/Command-line_tools/babel.html">SMILES 格式</a> 转换为其它格式文件：</p>
<pre tabindex="0"><code>obabel -:&#34;C1=CC2=C3C(=C1)C=CC4=CC=CC(=C43)C=C2&#34; -O pyrene.mol2 --gen3D
obabel -:&#34;C1=CC2=C3C(=C1)C=CC4=CC=CC(=C43)C=C2&#34; -O pyrene.pdb --gen3D
</code></pre><p>可利用<a href="https://www.novoprolabs.com/tools/smiles2pdb">网络服务器</a>进行结构转换；亦可制作 Automator 脚本，快捷转换大量文件（pdb, mol2, sdf, mol）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>/usr/local/bin:$PATH
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> f in <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>	file_path<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>f%/*<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>  	file<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>basename $f<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>  	file_name<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>file%.*<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>  	file_extension<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>file##*.<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $file_extension <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;sdf&#34;</span> <span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		obabel -h -isdf $f -omol &gt; $file_path/$file_name.mol
</span></span><span style="display:flex;"><span>		obabel -h -isdf $f -opdb &gt; $file_path/$file_name.pdb
</span></span><span style="display:flex;"><span>		obabel -h -isdf $f -omol2 &gt; $file_path/$file_name.mol2
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">elif</span> <span style="color:#f92672">[[</span> $file_extension <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;pdb&#34;</span> <span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		obabel -h -ipdb $f -omol &gt; $file_path/$file_name.mol
</span></span><span style="display:flex;"><span>		obabel -h -ipdb $f -omol2 &gt; $file_path/$file_name.mol2
</span></span><span style="display:flex;"><span>		obabel -h -ipdb $f -osdf &gt; $file_path/$file_name.sdf
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">elif</span> <span style="color:#f92672">[[</span> $file_extension <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;mol&#34;</span> <span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		obabel -h --gen3d -imol $f -omol2 &gt; $file_path/$file_name.mol2
</span></span><span style="display:flex;"><span>		obabel -h --gen3d -imol $f -opdb &gt; $file_path/$file_name.pdb
</span></span><span style="display:flex;"><span>		obabel -h --gen3d -imol $f -osdf &gt; $file_path/$file_name.sdf
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">elif</span> <span style="color:#f92672">[[</span> $file_extension <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;mol2&#34;</span> <span style="color:#f92672">]]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		obabel -h -imol2 $f -omol &gt; $file_path/$file_name.mol
</span></span><span style="display:flex;"><span>		obabel -h -imol2 $f -opdb &gt; $file_path/$file_name.pdb
</span></span><span style="display:flex;"><span>		obabel -h -imol2 $f -osdf &gt; $file_path/$file_name.sdf
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><h3 id="对-mol2-文件中分子的键重新排序">对 mol2 文件中分子的键重新排序</h3>
<p>下载该 <a href="http://www.mdtutorials.com/gmx/complex/Files/sort_mol2_bonds.pl">Perl 脚本</a>，将其放入我们的工作目录中，用该脚本对 mol2 文件中分子的键 @&lt;TRIPOS&gt;BOND 重新排序，并将排序后的文件命名为 <code>pyrene_clean.mol2</code>。</p>
<pre tabindex="0"><code>perl sort_mol2_bonds.pl pyrene.mol2 pyrene_clean.mol2
</code></pre><h3 id="力场文件">力场文件</h3>
<p>用于描述小分子的力场各不相同，譬如 <a href="http://mackerell.umaryland.edu/charmm_ff.shtml#gromacs">CHARMM36</a>，<a href="https://ambermd.org/antechamber/gaff.html">GAFF</a>。</p>
<ul>
<li>此处下载适用于 Gromacs 的最新版 CHARMM36 力场，即 <a href="http://mackerell.umaryland.edu/download.php?filename=CHARMM_ff_params_files/charmm36-jul2021.ff.tgz">charmm36-jul2021.ff.tgz</a></li>
<li>解压缩得到一个名为 <code>charmm36-jul2021.ff</code> 的文件夹，将其移入工作文件目录 <code>pyrene</code> 中。</li>
</ul>
<h3 id="生成分子的力场文件-top">生成分子的力场文件 *.top</h3>
<p>根据选择力场的不同，用于生成分子力场文件的工具也不同。该案例中我们使用  CHARMM36 力场，可选用 <a href="https://cgenff.umaryland.edu/">CGenff 网络服务器</a> 生成 CHARMM 格式的力场文件。在 CGenFF 服务器上注册并创建一个免费帐户，上传我们整理好的 pyrene_clean.mol2 文件，它会生成 pyrene_clean.str 文件，该文件即是 CHARMM 格式的力场文件，下载该文件。</p>
<p>因为我们需在 Gromacs 中进行分子动力学模拟，故需要将上述 CHARMM 格式的力场文件转换为 Gromacs 格式的力场文件。下载<a href="https://github.com/Bioinformatics-Review/MD-simulation-files/blob/master/cgenff_charmm2gmx.py">该 python2 脚本</a>，放入我们的工作目录中。创建一个适合该文件运行的 python2 环境：</p>
<pre tabindex="0"><code># 创建虚拟环境
conda create cgenff_charmm2gmx
conda activate cgenff_charmm2gmx

# 安装相应的包（注意版本）
conda install python==2.7
conda install numpy==1.12.1
pip install networkx==1.11 
pip install decorator==3.4.2

# 执行力场文件的格式转换
python cgenff_charmm2gmx.py pyrene pyrene_clean.mol2 pyrene.str charmm36-jul2021.ff
</code></pre><p>成功运行后，我们即可得到 pyrene 小分子的力场文件 <code>pyrene.top</code>，该分子单独的力场文件为 <code>pyrene.itp</code>，并被引入到 <code>pyrene.top</code> 中，该分子所需的其他参数被写入 <code>pyrene.prm</code> 文件中，一并被引入到 <code>pyrene.top</code> 中。</p>
<pre tabindex="0"><code>NOTE1: Code tested with python 2.7.3. Your version: 2.7.18 |Anaconda, Inc.| (default, Apr 23 2020, 17:44:47) 
[GCC 4.2.1 Compatible Clang 4.0.1 (tags/RELEASE_401/final)]

NOTE2: Please be sure to use the same version of CGenFF in your simulations that was used during parameter generation:
--Version of CGenFF detected in  pyrene.str : 4.6
--Version of CGenFF detected in  charmm36-jul2021.ff/forcefield.doc : 4.6

NOTE3: In order to avoid duplicated parameters, do NOT select the &#39;Include parameters that are already in CGenFF&#39; option when uploading a molecule into CGenFF.
============ DONE ============
Conversion complete.
The molecule topology has been written to pyrene.itp
Additional parameters needed by the molecule are written to pyrene.prm, which needs to be included in the system .top
============ DONE ============
</code></pre><p><strong>重复以上所有步骤，即可得到不同分子的力场文件 .top。</strong></p>
<p><strong>复制一份<code>pyrene.top</code>，并将其重命名为<code>sys.top</code>，用以存放系统中所有的分子力场信息。</strong></p>
<h3 id="安装-gromacs">安装 GROMACS</h3>
<p>在终端中安装 <a href="https://www.gromacs.org/">GROMACS</a>：</p>
<pre tabindex="0"><code>brew install gromacs
</code></pre><h3 id="gro-文件定义盒子及分子在盒子中的座标信息">*.gro 文件：定义盒子及分子在盒子中的座标信息</h3>
<p>利用前面 cgenff_charmm2gmx.py 处理时得到的 pyrene_ini.pdb 文件，在终端执行如下代码，将其转换为 <code>pyrene.gro</code> 文件。该文件记录了分子中每个原子在一个长宽高均为 3 nm 的空间中的位置信息。</p>
<pre tabindex="0"><code>gmx editconf -f pyrene_ini.pdb   -o pyrene.gro -box 3 3 3

Read 26 atoms
No velocities found
    system size :  0.920  0.679  0.003 (nm)
    center      :  0.000 -0.000 -0.000 (nm)
    box vectors :  0.000  0.000  0.000 (nm)
    box angles  :   0.00   0.00   0.00 (degrees)
    box volume  :   0.00               (nm^3)
    shift       :  1.500  1.500  1.500 (nm)
new center      :  1.500  1.500  1.500 (nm)
new box vectors :  3.000  3.000  3.000 (nm)
new box angles  :  90.00  90.00  90.00 (degrees)
new box volume  :  27.00               (nm^3)
</code></pre><p><strong>重复以上所有步骤，即可得到不同分子的 gro 文件。</strong></p>
<p><strong>复制一份<code>pyrene.gro</code>，并将其重命名为<code>sys.gro</code>，用以存放系统中所有的分子力场信息。</strong></p>
<h3 id="向盒子中添加更多的分子分子浓度">向盒子中添加更多的分子（分子浓度）</h3>
<p>向该分子座标文件 <code>sys.gro</code> 中再随机添加 30 个 pyrene 分子，得到一个含有 31 个小分子的座标文件 <code>sys_num.gro</code>。<strong>注意修改 <code>sys.top</code> 文件中， [ molecules ] 项下的 pyrene 的分子数量，1 ==&gt; 31</strong>。</p>
<pre tabindex="0"><code>gmx insert-molecules -f pyrene.gro -ci pyrene.gro -o sys_num.gro -nmol 30 -rot xyz -try 100

Reading solute configuration
Initialising inter-atomic distances...

WARNING: Masses and atomic (Van der Waals) radii will be guessed
         based on residue and atom names, since they could not be
         definitively assigned from the information in your input
         files. These guessed numbers might deviate from the mass
         and radius of the atom type. Please check the output
         files if necessary. Note, that this functionality may
         be removed in a future GROMACS version. Please, consider
         using another file format for your input.

NOTE: From version 5.0 gmx insert-molecules uses the Van der Waals radii
from the source below. This means the results may be different
compared to previous GROMACS versions.

++++ PLEASE READ AND CITE THE FOLLOWING REFERENCE ++++
A. Bondi
van der Waals Volumes and Radii
J. Phys. Chem. 68 (1964) pp. 441-451
-------- -------- --- Thank You --- -------- --------

Using random seed -219709635
Try 1 success (now 52 atoms)!
Try 2 success (now 78 atoms)!
Try 3 success (now 104 atoms)!
Try 4 success (now 130 atoms)!
Try 5 success (now 156 atoms)!
Try 7 success (now 182 atoms)!
Try 8 success (now 208 atoms)!
Try 12 success (now 234 atoms)!
Try 13 success (now 260 atoms)!
Try 14 success (now 286 atoms)!
Try 15 success (now 312 atoms)!
Try 16 success (now 338 atoms)!
Try 19 success (now 364 atoms)!
Try 22 success (now 390 atoms)!
Try 25 success (now 416 atoms)!
Try 30 success (now 442 atoms)!
Try 32 success (now 468 atoms)!
Try 34 success (now 494 atoms)!
Try 40 success (now 520 atoms)!
Try 44 success (now 546 atoms)!
Try 49 success (now 572 atoms)!
Try 59 success (now 598 atoms)!
Try 61 success (now 624 atoms)!
Try 62 success (now 650 atoms)!
Try 65 success (now 676 atoms)!
Try 66 success (now 702 atoms)!
Try 67 success (now 728 atoms)!
Try 75 success (now 754 atoms)!
Try 82 success (now 780 atoms)!
Try 83 success (now 806 atoms)!

Added 30 molecules (out of 30 requested)
Writing generated configuration to pyrene_num.gro

Output configuration contains 806 atoms in 31 residues
</code></pre><p><strong>重复以上添加分子的步骤，即可向盒子中添加不同的分子：</strong></p>
<pre tabindex="0"><code># 向前面生成的 sys_num.gro 文件中，再添加 30 个 fav 分子，重新生成一个 sys_num2.gro 文件
gmx insert-molecules -f sys_num.gro -ci fav.gro -o sys_num2.gro -nmol 30 -rot xyz -try 100 
</code></pre><p><strong>注意在 <code>sys.top</code> 文件中， [ molecules ] 项下添加 fav 分子以及相应的数量 30</strong>。</p>
<h3 id="向盒子中添加溶剂">向盒子中添加溶剂</h3>
<pre tabindex="0"><code>gmx solvate -cp sys_num2.gro -cs spc216.gro -o sys_num2_solv.gro -p sys.top


Reading solute configuration
Reading solvent configuration

Initialising inter-atomic distances...

WARNING: Masses and atomic (Van der Waals) radii will be guessed
         based on residue and atom names, since they could not be
         definitively assigned from the information in your input
         files. These guessed numbers might deviate from the mass
         and radius of the atom type. Please check the output
         files if necessary. Note, that this functionality may
         be removed in a future GROMACS version. Please, consider
         using another file format for your input.

NOTE: From version 5.0 gmx solvate uses the Van der Waals radii
from the source below. This means the results may be different
compared to previous GROMACS versions.

++++ PLEASE READ AND CITE THE FOLLOWING REFERENCE ++++
A. Bondi
van der Waals Volumes and Radii
J. Phys. Chem. 68 (1964) pp. 441-451
-------- -------- --- Thank You --- -------- --------

Generating solvent configuration
Will generate new solvent configuration of 2x2x2 boxes
Solvent box contains 3618 atoms in 1206 residues
Removed 966 solvent atoms due to solvent-solvent overlap
Removed 942 solvent atoms due to solute-solvent overlap
Sorting configuration
Found 1 molecule type:
    SOL (   3 atoms):   570 residues
Generated solvent containing 1710 atoms in 570 residues
Writing generated configuration to pyrene_num_solv.gro

Output configuration contains 2516 atoms in 601 residues
Volume                 :          27 (nm^3)
Density                :     1017.14 (g/l)
Number of solvent molecules:    570   

Processing topology
Adding line for 570 solvent molecules with resname (SOL) to topology file (sys.top)

Back Off! I just backed up sys.top to ./#sys.top.1#
</code></pre><p>如此，我们便得到一个包含了 570 个溶剂分子，31 个溶质分子的立方体座标体系，<code>pyrene_num_solv.gro</code>，其相应的分子信息以可在其力场文件中查看到。</p>
<h3 id="能量最小化测试系统是否正确-可省略">能量最小化，测试系统是否正确 （可省略）</h3>
<p>此时，我们需要一个任务描述文件 *.mdp，即告诉 Gromacs 执行何种任务，以及如何执行，其我们在该任务文件中设定需要的参数。</p>
<p>譬如我们此时需要做一个能量最小化的模拟，Energy Minimization (em.mdp) 需要一个任务文件，该文件可在<a href="https://github.com/Bioinformatics-Review/MD-simulation-files/blob/fe6a57da10345b18f746c5e33d92aa0594875e75/em.mdp">此处下载</a>，其中参数可自行设定。而后执行如下命令，得到 ``</p>
<pre tabindex="0"><code>gmx grompp -f em.mdp -c pyrene_num_solv.gro -p pyrene.top
</code></pre><p>即可快速验证系统是否正确。</p>
<h3 id="准备输入文件的代码汇总"><strong>准备输入文件的代码汇总</strong></h3>
<pre tabindex="0"><code># Get Mol2 files
obabel -:&#34;C1=CC2=C3C(=C1)C=CC4=CC=CC(=C43)C=C2&#34; -O pyrene.mol2 --gen3D
obabel -:&#34;C1=CC2=C(C(=C1)O)C(=O)C3=C(C2=O)C=C(C=C3O)C(=O)O rhein&#34; -O rhein.mol2 --gen3D

# Correct the bonds
perl sort_mol2_bonds.pl pyrene.mol2 pyrene_clean.mol2
perl sort_mol2_bonds.pl rhein.mol2 rhein_clean.mol2

# Get .str files
http://cgenff.umaryland.edu/

# Change .str to .top
python cgenff_charmm2gmx.py pyrene pyrene_clean.mol2 pyrene.str charmm36-jul2021.ff
python cgenff_charmm2gmx.py rhein rhein_clean.mol2 rhein.str charmm36-jul2021.ff

# Get .gro (atom location in a box)
gmx editconf -f pyrene_clean.pdb -o pyrene.gro -box 3 3 3
gmx editconf -f rhein_ini.pdb   -o rhein.gro -box 3 3 3

# Add more molecuels
gmx insert-molecules -f pyrene.gro -ci pyrene.gro -o sys_num.gro -nmol 2 -rot xyz -try 100
gmx insert-molecules -f sys_num.gro -ci rhein.gro -o sys_num2.gro -nmol 3 -rot xyz -try 100

# Add water (Remember to dupulicate and modify the sys.top file)
gmx solvate -cp pyrene_num.gro -cs spc216.gro -o pyrene_num_solv.gro -p sys.top

# Energy minimisaiton test
gmx grompp -f em.mdp -c pyrene_num_solv.gro -p pyrene.top
gmx mdrun -v
</code></pre><h3 id="本地安装并启动-openmm-setup">本地安装并启动 openmm-setup</h3>
<pre tabindex="0"><code>conda deactivate # deactivate all virtual environments 
conda create -name openmm python=3 # create a virtual environment named openmm based on pyhton 3
conda activate openmm # # activate the openmm virtual environment
conda install -c conda-forge openmm-setup # install openmm 
openmm-setup # run openmm
</code></pre><h3 id="在-google-colab-中运行模拟">在 google colab 中运行模拟</h3>
<ul>
<li>将 gromacs 的力场文件导出来，gromacs/2022.2_1/share/gromacs/top 放入谷歌网盘。</li>
<li>将小分子的力场描述文件，pyrene.itp 与 pyrene.prm 放入上述文件</li>
<li>将小分子的 top 文件，gro 文件放入谷歌网盘。</li>
</ul>
<pre tabindex="0"><code>#@title  Install Dependencies
! wget https://repo.anaconda.com/miniconda/Miniconda3-py37_4.8.2-Linux-x86_64.sh
! chmod +x Miniconda3-py37_4.8.2-Linux-x86_64.sh
! bash ./Miniconda3-py37_4.8.2-Linux-x86_64.sh -b -f -p /usr/local

import sys
sys.path.append(&#39;/usr/local/lib/python3.7/site-packages/&#39;)

#@title Install OpenMM
!yes|conda install -c conda-forge openmm
</code></pre><p>修改如下代码的相关地址，在 openmm 运行模拟。</p>
<pre tabindex="0"><code>#@title This script was generated by OpenMM-Setup on 2022-08-11.
%cd /content/drive/MyDrive/DSDS/openmm_gromacs/MolecularTOPGRO/pyrene

# This script was generated by OpenMM-Setup on 2022-08-14.

from openmm import *
from openmm.app import *
from openmm.unit import *

# Input Files

gro = GromacsGroFile(&#39;/content/drive/MyDrive/DSDS/openmm_gromacs/MolecularTOPGRO/pyrene/confout.gro&#39;)
top = GromacsTopFile(&#39;/content/drive/MyDrive/DSDS/openmm_gromacs/MolecularTOPGRO/pyrene/pyrene.top&#39;, includeDir=&#39;/content/drive/MyDrive/DSDS/openmm_gromacs/ForceFieldTOP&#39;,
    periodicBoxVectors=gro.getPeriodicBoxVectors())

# System Configuration

nonbondedMethod = PME
nonbondedCutoff = 1.0*nanometers
ewaldErrorTolerance = 0.0005
constraints = HBonds
rigidWater = True
constraintTolerance = 0.000001
hydrogenMass = 1.5*amu

# Integration Options

dt = 0.004*picoseconds
temperature = 300*kelvin
friction = 1.0/picosecond
pressure = 1.0*atmospheres
barostatInterval = 25

# Simulation Options

steps = 500000
equilibrationSteps = 1000
platform = Platform.getPlatformByName(&#39;CPU&#39;)
dcdReporter = DCDReporter(&#39;trajectory.dcd&#39;, 10000)
dataReporter = StateDataReporter(&#39;log.txt&#39;, 1000, totalSteps=steps,
    step=True, time=True, speed=True, progress=True, elapsedTime=True, remainingTime=True, potentialEnergy=True, kineticEnergy=True, totalEnergy=True, temperature=True, volume=True, density=True, separator=&#39;\t&#39;)
checkpointReporter = CheckpointReporter(&#39;checkpoint.chk&#39;, 10000)

# Prepare the Simulation

print(&#39;Building system...&#39;)
topology = top.topology
positions = gro.positions
system = top.createSystem(nonbondedMethod=nonbondedMethod, nonbondedCutoff=nonbondedCutoff,
    constraints=constraints, rigidWater=rigidWater, ewaldErrorTolerance=ewaldErrorTolerance, hydrogenMass=hydrogenMass)
system.addForce(MonteCarloBarostat(pressure, temperature, barostatInterval))
integrator = LangevinMiddleIntegrator(temperature, friction, dt)
integrator.setConstraintTolerance(constraintTolerance)
simulation = Simulation(topology, system, integrator, platform)
simulation.context.setPositions(positions)

# Minimize and Equilibrate

print(&#39;Performing energy minimization...&#39;)
simulation.minimizeEnergy()
print(&#39;Equilibrating...&#39;)
simulation.context.setVelocitiesToTemperature(temperature)
simulation.step(equilibrationSteps)

# Simulate

print(&#39;Simulating...&#39;)
simulation.reporters.append(dcdReporter)
simulation.reporters.append(dataReporter)
simulation.reporters.append(checkpointReporter)
simulation.currentStep = 0
simulation.step(steps)
</code></pre><h3 id="模拟结果分析">模拟结果分析</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>可视化
</span></span><span style="display:flex;"><span>gmx trjconv -f traj.trr -o system.pdb -pbc whole
</span></span><span style="display:flex;"><span>gmx trjconv -f traj.trr -o system.pdb -pbc whole -b <span style="color:#ae81ff">100</span> -e <span style="color:#ae81ff">300</span> -skip <span style="color:#ae81ff">5</span> -sep
</span></span></code></pre></div><hr>
<p>参考目录：</p>
<ul>
<li><a href="https://bioinformaticsreview.com/20210211/tutorial-md-simulation-of-small-organic-molecules-using-gromacs/">MD Simulation of small organic molecules using GROMACS</a></li>
<li><a href="https://gcm.upc.edu/en/members/luis-carlos/molecular-dynamics">MD with GROMACS for SMALL molecules</a></li>
<li><a href="https://gcm.upc.edu/en/members/luis-carlos/molecular-dynamics/analyzing-md-from-gromacs">Analyzing MD from GROMACS</a></li>
</ul>


  <footer>
  
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/cn/2022-08-09/ambertools-openmm-md/">分子动力学模拟蛋白与小分子相互作用</a></span>
  <span class="nav-next"><a href="/cn/2022-12-31/annual-review/">2022 年终总结</a> &rarr;</span>
</nav>
<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/cn\/2022-08-09\/ambertools-openmm-md\/';
    
  } else if (e.which == 39) {  
    
    url = '\/cn\/2022-12-31\/annual-review\/';
    
  }
  if (url) window.location = url;
});
</script>






<script async src="/js/fix-toc.js"></script>


<script async src="/js/center-img.js"></script>


<script async src="/js/right-quote.js"></script>


<script async src="/js/fix-footnote.js"></script>


<script async src="/js/math-code.js"></script>


<script async src="/js/external-link.js"></script>


<script async src="/js/alt-title.js"></script>


<script async src="/js/header-link.js"></script>




<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-1988641-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-1988641-2');
</script>

  
  
  <hr>
  <div class="copyright">© <a href="/">XiaO</a> 2006 - 2022</div>
  
  </footer>
  </article>
  
  </body>
</html>

